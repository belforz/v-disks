<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Reset de Senha - V-Disk (Simulador)</title>
  <style>
    body { font-family: Arial, Helvetica, sans-serif; padding: 24px; background:#f7f7f7 }
    .card { max-width:640px; margin:32px auto; background:white; padding:20px; border-radius:8px; box-shadow:0 4px 12px rgba(0,0,0,0.06) }
    pre { background:#111; color:#e6ffda; padding:12px; border-radius:6px; overflow:auto }
    label { display:block; margin-top:12px }
    input[type=text], input[type=password] { width:100%; padding:8px; margin-top:6px; box-sizing:border-box }
    button { margin-top:12px; padding:10px 14px }
    .muted { color:#666; font-size:0.9em }
  </style>
</head>
<body>
  <div class="card">
    <h1>Reset de Senha (Simulador)</h1>
    <p class="muted">Esta página simula o frontend que receberá o token enviado por e-mail. Ela exibirá o token e permite inserir uma nova senha (não envia nada ao backend — é só um mock).</p>

    <div>
      <label>Token (lido da query string)</label>
      <pre id="token">(não foi possível ler o token)</pre>
    </div>

    <form id="resetForm" onsubmit="event.preventDefault(); submitPassword();">
      <label for="newPass">Nova senha</label>
      <input id="newPass" type="password" placeholder="Digite a nova senha" required />
      <button id="btnSubmit" type="submit">Alterar senha</button>
    </form>

    <div id="result" style="display:none; margin-top:16px">
      <strong id="resultTitle"></strong>
      <p class="muted" id="resultMsg"></p>
      <div id="resultDetails"></div>
    </div>
  </div>

  <script>
    function getQueryParam(name) {
      const urlParams = new URLSearchParams(window.location.search);
      return urlParams.get(name);
    }
    const token = getQueryParam('token');
    const tokenEl = document.getElementById('token');
    if (token) {
      tokenEl.textContent = token;
    } else {
      tokenEl.textContent = '(token não encontrado na query string)';
    }

    async function submitPassword() {
      const pass = document.getElementById('newPass').value;
      if (!token || !pass) {
        showResult('Erro', 'Token ou nova senha ausente.', '');
        return;
      }
      try {
        const resp = await fetch('/api/auth/change-password', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ token: token, newPassword: pass })
        });

        const contentType = resp.headers.get('content-type') || '';
        let data = null;
        let text = '';
        if (contentType.includes('application/json')) {
          try { data = await resp.json(); } catch (err) { text = await resp.text(); }
        } else {
          text = await resp.text();
        }

        if (resp.ok) {
          if (data && data.status === 'success') {
            showResult('Sucesso', 'Senha alterada com sucesso!', '');
          } else if (text) {
            showResult('Sucesso', 'Operação concluída (resposta não-JSON)', text);
          } else {
            showResult('Sucesso', 'Operação concluída.', 'Status: ' + resp.status);
          }
        } else {
          const msg = (data && data.message) ? data.message : (text || ('HTTP ' + resp.status + ' ' + resp.statusText));
          showResult('Erro', msg, text || JSON.stringify(data));
        }

      } catch (e) {
        showResult('Erro', 'Erro de rede ou backend.', e.toString());
      }
    }

    function showResult(title, msg, details) {
      document.getElementById('resultTitle').textContent = title;
      document.getElementById('resultMsg').textContent = msg;
      document.getElementById('resultDetails').textContent = details || '';
      document.getElementById('result').style.display = 'block';
    }
  </script>
</body>
</html>
